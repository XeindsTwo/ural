@include('components/_head.html', {
title: 'Вокальный конкурс на Урале'
})

@include('components/_header.html')
<main>
  @include('home/_home.html')
  @include('home/_about.html')
  @include('home/_prizes.html')
  @include('home/_competition.html')
  @include('home/_jury.html')
  @include('home/_price.html')
  @include('home/_participation.html')
</main>
@include('components/_footer.html')
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/ScrollTrigger.min.js"></script>
<script src="js/main.min.js" type="module" defer></script>
<script src="js/phone-mask.js" defer></script>
<script>
  new Vue({
    el: '#app',
    data: {
      form: {
        contact: {
          phone: '',
          messenger: '',
          region: ''
        },
        personal: {
          fullName: '',
          age: '',
          address: ''
        },
        teacher: {
          fullName: '',
          schoolName: ''
        },
        video: null
      },
      errors: {
        contact: false,
        personal: false,
        emailInvalid: false,
        teacher: false,
        ageMin: false,
        ageMax: false,
        video: false,
        videoRequired: false,
        videoSizeExceeded: false,
        invalidFileType: false,
        formSubmission: false,
        region: false
      },
      errorTimer: null,
      submitting: false,
    },
    mounted() {
      new Choices('#mySelect', {
        searchEnabled: true,
        placeholder: true,
        placeholderValue: 'Выберите регион',
        searchPlaceholderValue: 'Поиск...',
      });

      document.getElementById('mySelect').addEventListener('change', this.handleRegionChange);
    },
    methods: {
      handleRegionChange(event) {
        this.form.contact.region = event.target.value;
        this.errors.region = !this.form.contact.region;
      },
      handleFileChange(event) {
        const file = event.target.files[0];
        const allowedTypes = ['video/mp4', 'video/webm', 'video/ogg'];

        if (file && this.form.video && file.name === this.form.video.name && file.size === this.form.video.size) {
          return;
        }

        if (file && !allowedTypes.includes(file.type)) {
          this.errors.invalidFileType = true;
          this.form.video = null;
        } else if (file) {
          document.getElementById('video').value = '';
          this.errors.videoSizeExceeded = file.size > 3500 * 1024 * 1024;
          if (!this.errors.videoSizeExceeded) {
            this.form.video = file;
            this.errors.invalidFileType = false;
          } else {
            this.form.video = null;
          }
          this.errors.videoRequired = false;
        }

        this.errors.video = false;
        clearTimeout(this.errorTimer);
        this.errorTimer = setTimeout(() => {
          this.errors.videoSizeExceeded = false;
          this.errors.invalidFileType = false;
        }, 2800);
      },
      removeVideo() {
        document.getElementById('video').value = '';
        this.form.video = null;

        clearTimeout(this.errorTimer);
        this.errors.videoSizeExceeded = false;
        this.errors.invalidFileType = false;
      },
      validateForm() {
        const emailPattern = /^([a-zA-Z0-9_.+-])+@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
        if (this.form.contact.messenger && !emailPattern.test(this.form.contact.messenger)) {
          this.errors.emailInvalid = true;
        }

        this.errors.contact = !this.form.contact.phone || !this.form.contact.messenger;
        this.errors.personal = !this.form.personal.fullName || !this.form.personal.age || !this.form.personal.address;

        const personalAge = parseInt(this.form.personal.age);
        this.errors.ageMin = personalAge < 10;
        this.errors.ageMax = personalAge > 70;

        const teacherFields = [this.form.teacher.fullName, this.form.teacher.schoolName];
        const anyTeacherFieldFilled = teacherFields.some(field => field.trim() !== '');
        const allTeacherFieldsFilled = teacherFields.every(field => field.trim() !== '');

        if (anyTeacherFieldFilled) {
          this.errors.teacher = !allTeacherFieldsFilled;
        }

        this.errors.region = !this.form.contact.region;

        if (this.form.video) {
          this.errors.videoSizeExceeded = this.form.video.size > 3500 * 1024 * 1024;
          this.errors.videoRequired = false;
        } else {
          this.errors.videoRequired = true;
        }

        if (!this.hasErrors()) {
          this.sendForm(anyTeacherFieldFilled);
        }

        clearTimeout(this.errorTimer);
        this.errorTimer = setTimeout(() => {
          this.resetForm();
        }, 2800);

        return Promise.resolve();
      },
      hasErrors() {
        for (const error in this.errors) {
          if (this.errors.hasOwnProperty(error) && this.errors[error]) {
            return true;
          }
        }
        return false;
      },
      async sendForm(teacherFilled = false) {
        try {
          this.submitting = true;

          const formData = new FormData();
          formData.append('contact[phone]', this.form.contact.phone);
          formData.append('contact[messenger]', this.form.contact.messenger);
          formData.append('contact[region]', this.form.contact.region);
          formData.append('personal[fullName]', this.form.personal.fullName);
          formData.append('personal[age]', this.form.personal.age);
          formData.append('personal[address]', this.form.personal.address);

          if (teacherFilled) {
            formData.append('teacher[fullName]', this.form.teacher.fullName.trim() || '');
            formData.append('teacher[schoolName]', this.form.teacher.schoolName.trim() || '');
          }

          if (this.form.video) {
            formData.append('video', this.form.video);
          }

          const response = await fetch('php/functions/process_form.php', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            const data = await response.json();
            console.error(data.message);
            this.errors.formSubmission = true;

            setTimeout(() => {
              this.errors.formSubmission = false;
            }, 4000);
          } else {
            this.resetForm();
          }
        } catch (error) {
          console.error('Error sending form data:', error);
          this.errors.formSubmission = true;

          setTimeout(() => {
            this.errors.formSubmission = false;
          }, 4000);
        } finally {
          this.submitting = false;
        }
      },
      resetForm() {
        this.errors.contact = false;
        this.errors.personal = false;
        this.errors.teacher = false;
        this.errors.emailInvalid = false;
        this.errors.ageMin = false;
        this.errors.ageMax = false;
        this.errors.videoRequired = false;
        this.errors.videoSizeExceeded = false;
        this.errors.invalidFileType = false;
        this.errors.region = false;
      }
    }
  });
</script>